angular.module("krumiroApp").controller("TempiCtrl",["$scope","$http","$interval","$timeout","$window","AES","Logger",function(a,b,c,d,e,f,g){function n(a,b){return a.time>b.time?1:a.time<b.time?-1:0}function o(a){var b=a&&!$.isEmptyObject(a)?JSON.stringify(a):"verificare le credenziali e riprovare.";g.error("ERRORE richiesta file degli storici",b)}function p(b){a.context.allitems=b.data,a.context.meta=b.meta,a.calcAllItems()}function q(){if(localStorage){var b=localStorage.getItem(l);if(b&&!(b.length<=0))try{var c=JSON.parse(b);if(c&&(a.context.options.lockuser=c.lockuser,a.context.options.alarms=c.alarms,a.context.options.checklunch=c.checklunch,a.context.options.checkmine=c.checkmine,a.context.options.checknine=c.checknine,a.context.options.lockuser&&c.crd&&c.crd.name&&c.crd.pswd))try{a.context.user.name=f.decrypt(c.crd.name,j),a.context.user.password=f.decrypt(c.crd.pswd,j)}catch(d){g.error("Impossibile recuperare le credenziali",d)}}catch(d){localStorage.clear()}}}function r(){if(localStorage){a.context.options.crd={},a.context.options.lockuser&&(a.context.options.crd.name=f.encrypt(a.context.user.name,j),a.context.options.crd.pswd=f.encrypt(a.context.user.password,j));var b=JSON.stringify(a.context.options);localStorage.setItem(l,b)}}function s(c){if(!a.milking){r(),a.milking=!0;var d={all:c,user:a.context.user,work:w(a.context.o),perm:w(a.context.p)};b.post("/api/inaz",d).success(function(b){if(b&&b.data.length)if(c)p(b);else{var d=[],e={};b.data.forEach(function(a){a.time=w(a.C2+":"+a.C3)}),b.data.sort(n),b.data.forEach(function(a){"E"==a.C4?(e.E&&(d.push(e),e={}),e.E=a.C2+":"+a.C3):"U"==a.C4&&(e.U&&(d.push(e),e={}),e.U=a.C2+":"+a.C3)}),(e.E||e.U)&&d.push(e),a.context.items=d,a.recalc()}b&&b.error&&g.warning("Attenzione",b.error),a.milking=!1}).error(function(b){a.milking=!1,o(b)})}}function u(){a.context.user.auto&&!t?a.start():!a.context.user.auto&&t&&a.stop()}function v(a,b,c){var d=parseInt(a)||0;return b>d&&(d=b),d>c&&(d=c),d}function w(a){if(!a)return 0;var b=/\d+/g,c=a.match(b),d=0;if(c&&c.length>0){var e=v(c[0],0,23),f=0;c.length>1&&(f=v(c[1],0,59)),d=60*e+f}return d}function x(a){if(!a)return 0;var b=/\d+/g,c=a.match(b),d=0;if(c&&c.length>0){var e=v(c[0],0,23),f=0;c.length>1&&(f=v(c[1],0,50),f=f?.5:0),d=e+f}return d}function y(b,c){return c>0&&b>0&&b>a.context.options.start_lunch&&c<a.context.options.end_lunch}function z(a){var b=0>a?-1:1;0>a&&(a=-a);var c=Math.floor(a/60),d=a-60*c;return d.toString().length<2&&(d="0"+d),c*b+":"+d}function C(a,b){var c=w(a[b]);return a[b+"M"]=c,c}function D(){return a.context.user.name&&a.context.user.password}function E(a,b){return b=b||"00",a.length<b.length&&(a=b.substr(0,b.length-a.length)+a),a}function F(a){var b=/(\d{1,2})\/(\d{1,2})\/(\d{4})/g;if(!a||a.length>10||a.length<8)return 0;var c=b.exec(a);return c?parseInt(c[3]+E(c[2])+E(c[1])):0}function G(b){return b.da=F(a.context.analisys.da),b.a=F(a.context.analisys.a),b.da>0&&b.a>0}function H(a){var b=0,c=0;return a.forEach(function(a){c>0?(b+=a.time-c,c=0):c=a.time}),b}function I(b,c,d){if(!(d.length<=0)){var e={day:c,dayn:F(c),items:d.sort(n)};if(a.context.meta.length>0){var f=$.grep(a.context.meta,function(a){return a.day==c});f&&f.length>0&&(f[0].perm>0&&(e.perm=f[0].perm),480!=f[0].work&&(e.work=f[0].work))}b.push(e)}}function J(){var a=new Date;return 60*a.getHours()+a.getMinutes()}function K(b,c){return i={i:b,p:c},a.alarm(),!0}function L(){!angular.isDefined(m)&&a.context.options.alarms&&(m=c(function(){var b=J();a.context.exitm&&h.paused&&b>=a.context.exitm?(a.alarmed=!0,a.alarm()):a.context.items.some(function(a){return a.EM&&a.EM<=b&&a.ealarm?K(a,"ealarm"):a.UM&&a.UM<=b&&a.ualarm?K(a,"ualarm"):!1})},1e4))}function M(){angular.isDefined(m)&&(c.cancel(m),m=void 0),a.alarmed=!1}function N(){if(!a.milking){a.milking=!0;var c={user:a.context.user,date:a.context.rap.date};b.post("/api/rap",c).success(function(b){a.context.rap.items=b,a.milking=!1}).error(function(b){a.milking=!1,o(b)})}}var i,h=new Audio("assets/media/alarm.mp3"),j="431a12934fc4914912895c5103aa51b0",k="-1000px";const l="OPT";var m;a.helpon=!1,a.helpstyle={top:k},a.analisyson=!1,a.showopt=!1,a.optstyle={height:0},a.progress={forecolor:"yellowgreen",value:0,diameter:32,border:1},a.context={o:"8",p:"",exit:"?",items:[{E:"8:30",U:""}],options:{lockuser:!1,alarms:!1,checknine:!0,checklunch:!0,checkmine:!0,canautomilk:!1,halfday:240,min_e:510,max_e:540,max_u:1380,min_lunch:30,max_lunch:90,start_lunch:750,end_lunch:870},debug:{}},a.instractions={title:"Cosa puoi fare con QUANDO?",footer:"Se non ti basta .....",sections:[{icon:"fa-clock-o",title:"Puoi simulare le tue entrate ed uscite...",desc:"Inserendo le tue entrate e le tue uscite otterrai in automatico l'individuazione della pausa pranzo e l'ora di uscita."},{icon:"fa-clock-o",title:"Puoi impostare le ore di lavoro e di permesso...",desc:"Valorizzando correttamente le ore di permesso o di lavoro nel giorno puoi variare il calcolo dell'ora di uscita."},{icon:"fa-cloud-download",title:"Con le credenziali INAZ acquisisci i dati reali...",desc:"Inserendo le credenziali INAZ puoi scaricare manualmente le bedgiature cliccando sulla nuvoletta.\r\nOppure, attivando l'interruttore puoi lasciare fare all'applicazione che alliner\xe0 i dati ogni mezzo minuto."},{icon:"fa-calendar",title:"Vedere lo storico delle tue bedgiature...",desc:"Inserendo le credenziali INAZ puoi scaricare lo storico delle tue bedgiature cliccando sul calendarino sulla destra."},{icon:"fa-paw",title:"Vedere i rapportini lavorati nel mese...",desc:"Inserendo le credenziali INAZ puoi visualizzare l'elenco mensile dei rapportini e fare le tue ricerche calcolando le ore lavorate per commessa o lavoro o quant'altro."},{icon:"fa-bullhorn",title:"Aggiungere un allarme per ogni orario che desideri...",desc:"Attivando il megafonino in basso a sinistra puoi farti avvisare acusticamente (quindi devi avere il volume e degli altoparlanti attivi) all'ora d'uscita e, attivandoli separatamente ad ogni orario definito (altoparlantino nella cella dell'orario valorizzato)."}]},a.toggleOptions=function(){a.showopt=!a.showopt,a.optstyle={height:a.showopt?"165px":"0"}},a.toggleOptionValue=function(b){a.context.options[b]=!a.context.options[b],a.recalc(),r()},a.toggleLockUser=function(){a.context.options.lockuser=!a.context.options.lockuser,r()},a.milking=!1;var t;a.start=function(){a.stop(),t=c(s,3e4)},a.stop=function(){t&&(c.cancel(t),t=null)},a.$on("$destroy",function(){a.stop()});var A=["Luned\xec","Marted\xec","Mercoled\xec","Gioved\xec","Venerd\xec","Sabato","Domenica"],B=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];a.getDate=function(a,b){b=b||"/";var c=new Date;return"small"==a?c.getDate()+b+(c.getMonth()+1)+b+c.getFullYear():"verysmall"==a?c.getMonth()+1+b+c.getFullYear():A[c.getDay()-1]+" "+c.getDate()+" "+B[c.getMonth()]+" "+c.getFullYear()},a.recalc=function(){var b=0,c=0,d=w(a.context.o),e=w(a.context.p),f=0,g=!1,h=0,i=0,j=0,k=0,l=!1,m=e<a.context.options.halfday&&a.context.options.checklunch;a.context.items.forEach(function(d){if(j=C(d,"E"),j<a.context.options.min_e&&a.context.options.checkmine&&(j=a.context.options.min_e),!l&&y(j,k)&&a.context.options.checklunch){l=!0,d.lunch=!0;var m=j-k;m<a.context.options.min_lunch&&(b=a.context.options.min_lunch-m,m=a.context.options.min_lunch),m>a.context.options.max_lunch&&(b=m-a.context.options.max_lunch,m=a.context.options.max_lunch),d.L=z(m)}else d.lunch=!1;if(k=C(d,"U"),g=k>j){var n=k-j;d.minutes=z(n),f+=n}else d.minutes=0;if(j>0&&d.E){if(i=j,0==h&&(h=j,h>a.context.options.max_e&&0>=e&&a.context.options.checknine)){var o=h-a.context.options.max_e,p=Math.floor(o/30);o>30*p&&p++,c=30*p-o}k>0&&(i=k)}}),g&&a.context.items.push({E:"",U:""}),!l&&m&&(b=a.context.options.min_lunch);var n=i+d-f+b-e+c;(n<=a.context.options.min_e||n>=a.context.options.max_u)&&(n=0),a.context.startm=h,a.context.exitm=n,a.context.exit=n>0?z(n):"?",L()},a.clear=function(){var b=a.context&&a.context.user?a.context.user:{},c=a.context.options;a.context={user:b,o:"8",p:"0",exit:"?",items:[{E:"8:30",U:""}],options:c,analisys:{da:"01/01/2015",a:a.getDate("small"),results:[]},rap:{date:a.getDate("verysmall")},debug:{}},q(),a.recalc()},a.toggleAutoInaz=function(){a.context.user.auto=!a.context.user.auto,u()},a.inazall=function(){a.context.allDaysItems&&a.context.allDaysItems.length?a.context.allDaysItems=[]:(a.context.rap.items=void 0,s(!0))},a.inaz=function(){D()&&!a.context.user.auto&&s()},a.analisys=function(){a.analisyson=!a.analisyson,a.analisyson&&a.recalcAnal()},a.recalcAnal=function(){if(a.context.allDaysItems&&!(a.context.allDaysItems.length<=0)){var b={da:0,a:0};if(G(b)){var c={days:0,work:0,done:0,perm:0};a.context.allDaysItems.forEach(function(a){if(a.dayn>=b.da&&a.dayn<=b.a){var d=H(a.items);d>0&&(c.days++,c.work+=a.work||480,c.done+=d,c.perm+=a.perm||0)}}),a.context.analisys.results=[{name:"Giorni considerati",value:c.days},{name:"Totale ore da lavorare",value:z(c.work)},{name:"Totale ore lavorate",value:z(c.done)},{name:"Permessi",value:z(c.perm)},{name:"Differenza*",value:z(c.done-c.work+c.perm)}]}}},a.calcAllItems=function(){if(a.context.allitems&&!(a.context.allitems.length<=0)){var b=[],c=[],d="";a.context.allitems.forEach(function(a){d!=a.C1&&(I(c,d,b),d=a.C1,b=[]),a.time=w(a.C2+":"+a.C3),b.push(a)}),I(c,d,b),a.context.allDaysItems=c}},a.alarm=function(){h.paused?(a.context.options.alarms&&h.play(),i&&(i.i[i.p+"ed"]=!0)):(h.pause(),i||M(),i&&(i.i[i.p+"ed"]=!1,i.i[i.p]=!1,i=null)),a.isalarm=!h.paused},a.toggleAlarms=function(){a.context.options.alarms?(a.context.options.alarms=!1,M(),h.paused||a.alarm()):(a.context.options.alarms=!0,L()),r()},a.help=function(){a.helpon=!a.helpon,a.helpstyle={top:a.helpon?"10px":k}},a.downloadHistory=function(){if(D()){var c={user:a.context.user};b.post("/api/inaz/download",c).success(function(b){var c=JSON.stringify(b);c=c.replace(/,"\$\$hashKey":"object:\d+"/g,""),c=c.replace(/},{/g,"},\r\n{"),c=c.replace(/],"/g,'],\r\n"'),c=c.replace(/:\[{/g,":[\r\n{");var d=new Blob([c],{type:"text/json;charset=utf-8"}),e=a.getDate(null,"-");saveAs(d,"history_"+e+".json")}).error(function(a){o(a)})}},a.uploadHistoryContent=function(c){if(D()){var d=new FileReader;d.onload=function(c){var d={user:a.context.user,history:c.target.result};b.post("/api/inaz/upload",d).success(function(a){g.ok("Storici aggiornati correttamente!"),p(a)}).error(function(a){g.error("Errore in fase di richiesta rapportini",a)})},d.readAsText(c.files[0])}},a.uploadHistory=function(){D()&&angular.element("#history-file").trigger("click")},c(function(){var b=J(),c=a.context.exitm-a.context.startm,d=J()-a.context.startm,e=a.context.exitm-b;a.progress.value=0>=c||0>=d?0:Math.floor(100*d/c),a.progress.elapsed=z(e)},2e3),a.togglerap=function(){a.context.rap.items?a.context.rap.items=void 0:(a.context.allDaysItems=[],N())},a.reloadRap=function(){N()},a.getFilteredSummary=function(){var b=0;return a.filtered&&a.filtered.forEach(function(a){b+=x(a.C5)}),a.rapSummary=b,a.rapSummaryGG=(b/8).toFixed(2),b},a.hendleKeySearch=function(b){13==b.keyCode&&a.reloadRap()},a.clear()}]);
