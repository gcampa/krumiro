angular.module("krumiroApp").controller("TempiCtrl",["$scope","$http","$interval","$timeout","$window","AES","Logger",function(a,b,c,d,e,f,g){function m(a,b){return a.time>b.time?1:a.time<b.time?-1:0}function n(a){var b=a&&!$.isEmptyObject(a)?JSON.stringify(a):"verificare le credenziali e riprovare.";g.error("ERRORE richiesta file degli storici",b)}function o(b){a.context.allitems=b.data,a.context.meta=b.meta,a.calcAllItems()}function p(){if(localStorage){var b=localStorage.getItem(k);if(b&&!(b.length<=0))try{var c=JSON.parse(b);if(c&&(a.context.options.lockuser=c.lockuser,a.context.options.alarms=c.alarms,a.context.options.checklunch=c.checklunch,a.context.options.checkmine=c.checkmine,a.context.options.checknine=c.checknine,a.context.options.lockuser&&c.crd&&c.crd.name&&c.crd.pswd))try{a.context.user.name=f.decrypt(c.crd.name,j),a.context.user.password=f.decrypt(c.crd.pswd,j)}catch(d){g.error("Impossibile recuperare le credenziali",d)}}catch(d){localStorage.clear()}}}function q(){if(localStorage){a.context.options.crd={},a.context.options.lockuser&&(a.context.options.crd.name=f.encrypt(a.context.user.name,j),a.context.options.crd.pswd=f.encrypt(a.context.user.password,j));var b=JSON.stringify(a.context.options);localStorage.setItem(k,b)}}function r(c){if(!a.milking){q(),a.milking=!0;var d={all:c,user:a.context.user,work:v(a.context.o),perm:v(a.context.p)};b.post("/api/inaz",d).success(function(b){if(b&&b.data.length)if(c)o(b);else{var d=[],e={};b.data.forEach(function(a){a.time=v(a.C2+":"+a.C3)}),b.data.sort(m),b.data.forEach(function(a){"E"==a.C4?(e.E&&(d.push(e),e={}),e.E=a.C2+":"+a.C3):"U"==a.C4&&(e.U&&(d.push(e),e={}),e.U=a.C2+":"+a.C3)}),(e.E||e.U)&&d.push(e),a.context.items=d,a.recalc()}b&&b.error&&g.warning("Attenzione",b.error),a.milking=!1}).error(function(b){a.milking=!1,n(b)})}}function t(){a.context.user.auto&&!s?a.start():!a.context.user.auto&&s&&a.stop()}function u(a,b,c){var d=parseInt(a)||0;return b>d&&(d=b),d>c&&(d=c),d}function v(a){if(!a)return 0;var b=/\d+/g,c=a.match(b),d=0;if(c&&c.length>0){var e=u(c[0],0,23),f=0;c.length>1&&(f=u(c[1],0,59)),d=60*e+f}return d}function w(b,c){return c>0&&b>0&&b>a.context.options.start_lunch&&c<a.context.options.end_lunch}function x(a){var b=0>a?-1:1;0>a&&(a=-a);var c=Math.floor(a/60),d=a-60*c;return d.toString().length<2&&(d="0"+d),c*b+":"+d}function A(a,b){var c=v(a[b]);return a[b+"M"]=c,c}function B(){return a.context.user.name&&a.context.user.password}function C(a,b){return b=b||"00",a.length<b.length&&(a=b.substr(0,b.length-a.length)+a),a}function D(a){var b=/(\d{1,2})\/(\d{1,2})\/(\d{4})/g;if(!a||a.length>10||a.length<8)return 0;var c=b.exec(a);return c?parseInt(c[3]+C(c[2])+C(c[1])):0}function E(b){return b.da=D(a.context.analisys.da),b.a=D(a.context.analisys.a),b.da>0&&b.a>0}function F(a){var b=0,c=0;return a.forEach(function(a){c>0?(b+=a.time-c,c=0):c=a.time}),b}function G(b,c,d){if(!(d.length<=0)){var e={day:c,dayn:D(c),items:d.sort(m)};if(a.context.meta.length>0){var f=$.grep(a.context.meta,function(a){return a.day==c});f&&f.length>0&&(f[0].perm>0&&(e.perm=f[0].perm),480!=f[0].work&&(e.work=f[0].work))}b.push(e)}}function H(){var a=new Date;return 60*a.getHours()+a.getMinutes()}function I(b,c){return i={i:b,p:c},a.alarm(),!0}function J(){!angular.isDefined(l)&&a.context.options.alarms&&(l=c(function(){var b=H();a.context.exitm&&h.paused&&b>=a.context.exitm?(a.alarmed=!0,a.alarm()):a.context.items.some(function(a){return a.EM&&a.EM<=b&&a.ealarm?I(a,"ealarm"):a.UM&&a.UM<=b&&a.ualarm?I(a,"ualarm"):!1})},1e4))}function K(){angular.isDefined(l)&&(c.cancel(l),l=void 0),a.alarmed=!1}var i,h=new Audio("assets/media/alarm.mp3"),j="431a12934fc4914912895c5103aa51b0";const k="OPT";var l;a.helpon=!1,a.helpstyle={top:"-700px"},a.analisyson=!1,a.showopt=!1,a.optstyle={height:0},a.progress={forecolor:"yellowgreen",value:0,diameter:32,border:1},a.context={o:"8",p:"",exit:"?",items:[{E:"8:30",U:""}],options:{lockuser:!1,alarms:!1,checknine:!0,checklunch:!0,checkmine:!0,canautomilk:!1,halfday:240,min_e:510,max_e:540,max_u:1380,min_lunch:30,max_lunch:90,start_lunch:750,end_lunch:870},debug:{}},a.instractions={title:"Cosa puoi fare con QUANDO?",footer:"Se non ti basta .....",sections:[{icon:"fa-clock-o",title:"Puoi simulare le tue entrate ed uscite...",desc:"Inserendo le tue entrate e le tue uscite otterrai in automatico l'individuazione della pausa pranzo e l'ora di uscita."},{icon:"fa-clock-o",title:"Puoi impostare le ore di lavoro e di permesso...",desc:"Valorizzando correttamente le ore di permesso o di lavoro nel giorno puoi variare il calcolo dell'ora di uscita."},{icon:"fa-cloud-download",title:"Con le credenziali INAZ acquisisci i dati reali...",desc:"Inserendo le credenziali INAZ puoi scaricare manualmente le bedgiature cliccando sulla nuvoletta.\r\nOppure, attivando l'interruttore puoi lasciare fare all'applicazione che alliner\xe0 i dati ogni mezzo minuto."},{icon:"fa-calendar",title:"Vedere lo storico dell'ultima settimana...",desc:"Inserendo le credenziali INAZ puoi scaricare lo storico degli ultimi giorni cliccando sul calendarino sulla destra."},{icon:"fa-bullhorn",title:"Aggiungere un allarme per ogni orario che desideri...",desc:"Attivando il megafonino in basso a sinistra puoi farti avvisare acusticamente (quindi devi avere il volume e degli altoparlanti attivi) all'ora d'uscita e, attivandoli separatamente ad ogni orario definito (altoparlantino nella cella dell'orario valorizzato)."}]},a.toggleOptions=function(){a.showopt=!a.showopt,a.optstyle={height:a.showopt?"165px":"0"}},a.toggleOptionValue=function(b){a.context.options[b]=!a.context.options[b],a.recalc(),q()},a.toggleLockUser=function(){a.context.options.lockuser=!a.context.options.lockuser,q()},a.milking=!1;var s;a.start=function(){a.stop(),s=c(r,3e4)},a.stop=function(){s&&(c.cancel(s),s=null)},a.$on("$destroy",function(){a.stop()});var y=["Luned\xec","Marted\xec","Mercoled\xec","Gioved\xec","Venerd\xec","Sabato","Domenica"],z=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];a.getDate=function(a,b){b=b||"/";var c=new Date;return a?c.getDate()+b+(c.getMonth()+1)+b+c.getFullYear():y[c.getDay()-1]+" "+c.getDate()+" "+z[c.getMonth()]+" "+c.getFullYear()},a.recalc=function(){var b=0,c=0,d=v(a.context.o),e=v(a.context.p),f=0,g=!1,h=0,i=0,j=0,k=0,l=!1,m=e<a.context.options.halfday&&a.context.options.checklunch;a.context.items.forEach(function(d){if(j=A(d,"E"),j<a.context.options.min_e&&a.context.options.checkmine&&(j=a.context.options.min_e),!l&&w(j,k)&&a.context.options.checklunch){l=!0,d.lunch=!0;var m=j-k;m<a.context.options.min_lunch&&(b=a.context.options.min_lunch-m,m=a.context.options.min_lunch),m>a.context.options.max_lunch&&(b=m-a.context.options.max_lunch,m=a.context.options.max_lunch),d.L=x(m)}else d.lunch=!1;if(k=A(d,"U"),g=k>j){var n=k-j;d.minutes=x(n),f+=n}else d.minutes=0;if(j>0&&d.E){if(i=j,0==h&&(h=j,h>a.context.options.max_e&&0>=e&&a.context.options.checknine)){var o=h-a.context.options.max_e,p=Math.floor(o/30);o>30*p&&p++,c=30*p-o}k>0&&(i=k)}}),g&&a.context.items.push({E:"",U:""}),!l&&m&&(b=a.context.options.min_lunch);var n=i+d-f+b-e+c;(n<=a.context.options.min_e||n>=a.context.options.max_u)&&(n=0),a.context.startm=h,a.context.exitm=n,a.context.exit=n>0?x(n):"?",J()},a.clear=function(){var b=a.context&&a.context.user?a.context.user:{},c=a.context.options;a.context={user:b,o:"8",p:"0",exit:"?",items:[{E:"8:30",U:""}],options:c,analisys:{da:"01/01/2015",a:a.getDate(!0),results:[]},debug:{}},p(),a.recalc()},a.toggleAutoInaz=function(){a.context.user.auto=!a.context.user.auto,t()},a.inazall=function(){a.context.allDaysItems&&a.context.allDaysItems.length?a.context.allDaysItems=[]:r(!0)},a.inaz=function(){B()&&!a.context.user.auto&&r()},a.analisys=function(){a.analisyson=!a.analisyson,a.analisyson&&a.recalcAnal()},a.recalcAnal=function(){if(a.context.allDaysItems&&!(a.context.allDaysItems.length<=0)){var b={da:0,a:0};if(E(b)){var c={days:0,work:0,done:0,perm:0};a.context.allDaysItems.forEach(function(a){if(a.dayn>=b.da&&a.dayn<=b.a){var d=F(a.items);d>0&&(c.days++,c.work+=a.work||480,c.done+=d,c.perm+=a.perm||0)}}),a.context.analisys.results=[{name:"Giorni considerati",value:c.days},{name:"Totale ore da lavorare",value:x(c.work)},{name:"Totale ore lavorate",value:x(c.done)},{name:"Permessi",value:x(c.perm)},{name:"Differenza*",value:x(c.done-c.work+c.perm)}]}}},a.calcAllItems=function(){if(a.context.allitems&&!(a.context.allitems.length<=0)){var b=[],c=[],d="";a.context.allitems.forEach(function(a){d!=a.C1&&(G(c,d,b),d=a.C1,b=[]),a.time=v(a.C2+":"+a.C3),b.push(a)}),G(c,d,b),a.context.allDaysItems=c}},a.alarm=function(){h.paused?(a.context.options.alarms&&h.play(),i&&(i.i[i.p+"ed"]=!0)):(h.pause(),i||K(),i&&(i.i[i.p+"ed"]=!1,i.i[i.p]=!1,i=null)),a.isalarm=!h.paused},a.toggleAlarms=function(){a.context.options.alarms?(a.context.options.alarms=!1,K(),h.paused||a.alarm()):(a.context.options.alarms=!0,J()),q()},a.help=function(){a.helpon=!a.helpon,a.helpstyle={top:a.helpon?"10px":"-700px"}},a.downloadHistory=function(){if(B()){var c={user:a.context.user};b.post("/api/inaz/download",c).success(function(b){var c=JSON.stringify(b);c=c.replace(/,"\$\$hashKey":"object:\d+"/g,""),c=c.replace(/},{/g,"},\r\n{"),c=c.replace(/],"/g,'],\r\n"'),c=c.replace(/:\[{/g,":[\r\n{");var d=new Blob([c],{type:"text/json;charset=utf-8"}),e=a.getDate("-");saveAs(d,"history_"+e+".json")}).error(function(a){n(a)})}},a.uploadHistoryContent=function(c){if(B()){var d=new FileReader;d.onload=function(c){var d={user:a.context.user,history:c.target.result};b.post("/api/inaz/upload",d).success(function(a){g.ok("Storici aggiornati correttamente!"),o(a)}).error(function(a){n(a)})},d.readAsText(c.files[0])}},a.uploadHistory=function(){B()&&angular.element("#history-file").trigger("click")},c(function(){var b=H(),c=a.context.exitm-a.context.startm,d=H()-a.context.startm,e=a.context.exitm-b;a.progress.value=0>=c||0>=d?0:Math.floor(100*d/c),a.progress.elapsed=x(e)},2e3),a.clear()}]);
