angular.module("krumiroApp").controller("TempiCtrl",["$scope","$http","$interval","$timeout","$window","Utilities","AES","Logger",function(e,t,o,n,a,i,r,c){function s(e,t){return e.time>t.time?1:e.time<t.time?-1:0}function l(e,t){t=t||"ERRORE richiesta file degli storici";var o=e&&!$.isEmptyObject(e)?e.message:"verificare le credenziali e riprovare.";c.error(t,o)}function u(t,o){e.context.options.debug&&(e.debuglines=e.debuglines||[],e.debuglines.push(t),$.isArray(o)?e.debuglines.push.apply(e.debuglines,o):e.debuglines.push(JSON.stringify(o)))}function p(t){e.context.allitems=t.data,e.context.meta=t.meta,e.calcAllItems()}function m(){if(localStorage){var t=localStorage.getItem(O);if(t&&t.length>0)try{var o=JSON.parse(t);if(o&&(e.context.options.lockuser=o.lockuser,e.context.options.alarms=o.alarms,e.context.options.checklunch=o.checklunch,e.context.options.checkmine=o.checkmine,e.context.options.checknine=o.checknine,e.context.options.lockuser&&o.crd&&o.crd.name&&o.crd.pswd))try{e.context.user.name=r.decrypt(o.crd.name,R),e.context.user.password=r.decrypt(o.crd.pswd,R),e.context.ass.name=r.decrypt(o.ass.name,R),e.context.ass.password=r.decrypt(o.ass.pswd,R)}catch(n){c.error("Impossibile recuperare le credenziali",n)}}catch(n){localStorage.clear()}}}function d(){if(localStorage){e.context.options.crd={},e.context.options.ass={},e.context.options.lockuser&&(e.context.options.crd.name=r.encrypt(e.context.user.name,R),e.context.options.crd.pswd=r.encrypt(e.context.user.password,R),e.context.options.ass.name=r.encrypt(e.context.ass.name,R),e.context.options.ass.pswd=r.encrypt(e.context.ass.password,R));var t=JSON.stringify(e.context.options);localStorage.setItem(O,t)}}function x(o){if(!e.milking){d(),e.milking=!0;var n={all:o,user:e.context.user,work:h(e.context.o),perm:h(e.context.p),debug:e.context.options.debug};t.post("/api/inaz",n).success(function(t){if(u("Risultati della mungitura inaz:",t.debug),t&&t.data.length)if(o)p(t);else{var n=[],a={};t.data.forEach(function(e){e.time=h(e.C2+":"+e.C3)}),t.data.sort(s),t.data.forEach(function(e){"E"==e.C4?(a.E&&(n.push(a),a={}),a.E=e.C2+":"+e.C3):"U"==e.C4&&(a.U&&(n.push(a),a={}),a.U=e.C2+":"+e.C3)}),(a.E||a.U)&&n.push(a),e.context.items=n,e.recalc()}t&&t.error&&c.warning("Attenzione",t.error),e.milking=!1}).error(function(t){t&&t.debug&&u("Risultati della mungitura inaz:",t.debug),e.milking=!1,l(t)})}}function g(){e.context.user.auto&&!N?e.start():!e.context.user.auto&&N&&e.stop()}function f(e,t,o){var n=parseInt(e)||0;return t>n&&(n=t),n>o&&(n=o),n}function h(e){if(!e)return 0;var t=/\d+/g,o=e.match(t),n=0;if(o&&o.length>0){var a=f(o[0],0,23),i=0;o.length>1&&(i=f(o[1],0,59)),n=60*a+i}return n}function v(t,o){return o>0&&t>0&&t>e.context.options.start_lunch&&o<e.context.options.end_lunch}function w(e,t){var o=h(e[t]);return e[t+"M"]=o,o}function z(){return e.context.user.name&&e.context.user.password}function y(t,o,n){if(n.length>0){var a={day:o,dayn:i.parseDate(o),items:n.sort(s)};if(e.context.meta.length>0){var r=$.grep(e.context.meta,function(e){return e.day==o});r&&r.length>0&&(r[0].perm>0&&(a.perm=r[0].perm),480!=r[0].work&&(a.work=r[0].work))}t.push(a)}}function b(){var e=new Date;return 60*e.getHours()+e.getMinutes()}function k(t,o){return I={i:t,p:o},e.alarm(),!0}function A(){!angular.isDefined(U)&&e.context.options.alarms&&(U=o(function(){var t=b();e.context.exitm&&D.paused&&t>=e.context.exitm?(e.alarmed=!0,e.alarm()):e.context.items.some(function(e){return e.EM&&e.EM<=t&&e.ealarm?k(e,"ealarm"):e.UM&&e.UM<=t&&e.ualarm?k(e,"ualarm"):!1})},1e4))}function E(){angular.isDefined(U)&&(o.cancel(U),U=void 0),e.alarmed=!1}function _(){if(!e.milking){e.milking=!0;var o={user:e.context.user,date:e.context.rap.date,advanced:e.context.rap.advanced,todate:e.context.rap.todate,debug:e.context.options.debug};t.post("/api/rap",o).success(function(t){u("Risultati della mungitura rapportini:",t.debug),e.context.rap.items=t.data,e.milking=!1}).error(function(t){e.milking=!1,l(t,"ERRORE richiesta rapportini")})}}function S(e){var t=[];return e.forEach(function(e){t.push(C(e))}),t}function C(e){var t={values:[]};for(var o in e)t.values.push(e[o]);return t}var I,D=new Audio("assets/media/alarm.mp3"),R="431a12934fc4914912895c5103aa51b0",M="-1000px";const O="OPT";var U;e.helpon=!1,e.helpstyle={top:M},e.showopt=!1,e.optstyle={height:0},e.progress={forecolor:"yellowgreen",value:0,diameter:32,border:1},e.context={o:"8",p:"",exit:"?",items:[{E:"8:30",U:""}],options:{lockuser:!1,alarms:!1,checknine:!0,checklunch:!0,checkmine:!0,canautomilk:!1,debug:!1,halfday:240,min_e:510,max_e:540,max_u:1380,min_lunch:30,max_lunch:90,start_lunch:750,end_lunch:870},debug:{}},e.instractions={title:"Cosa puoi fare con CRUMIRO?",footer:"Se non ti basta .....",sections:[{icon:"fa-clock-o",title:"Puoi simulare le tue entrate ed uscite...",desc:"Inserendo le tue entrate e le tue uscite otterrai in automatico l'individuazione della pausa pranzo e l'ora di uscita."},{icon:"fa-clock-o",title:"Puoi impostare le ore di lavoro e di permesso...",desc:"Valorizzando correttamente le ore di permesso o di lavoro nel giorno puoi variare il calcolo dell'ora di uscita."},{icon:"fa-cloud-download",title:"Con le credenziali INAZ acquisisci i dati reali...",desc:"Inserendo le credenziali INAZ puoi scaricare manualmente le bedgiature cliccando sulla nuvoletta.\r\nOppure, attivando l'interruttore puoi lasciare fare all'applicazione che allinerà i dati ogni mezzo minuto."},{icon:"fa-bug",title:"Consultare le anomalie...",desc:"Inserendo le credenziali @Assistant puoi scaricare l'elenco delle anomalie e filtrarle come desideri."},{icon:"fa-calendar",title:"Vedere lo storico delle tue bedgiature...",desc:"Inserendo le credenziali INAZ puoi scaricare lo storico delle tue bedgiature cliccando sul calendarino sulla destra."},{icon:"fa-paw",title:"Vedere i rapportini lavorati nel mese...",desc:"Inserendo le credenziali INAZ puoi visualizzare l'elenco mensile dei rapportini e fare le tue ricerche calcolando le ore lavorate per commessa o lavoro o quant'altro."},{icon:"fa-bullhorn",title:"Aggiungere un allarme per ogni orario che desideri...",desc:"Attivando il megafonino in basso a sinistra puoi farti avvisare acusticamente (quindi devi avere il volume e degli altoparlanti attivi) all'ora d'uscita e, attivandoli separatamente ad ogni orario definito (altoparlantino nella cella dell'orario valorizzato)."}]},e.toggleOptions=function(){e.showopt=!e.showopt,e.optstyle={height:e.showopt?"190px":"0"}},e.toggleOptionValue=function(t){e.context.options[t]=!e.context.options[t],"debug"!=t||e.context.options[t]||(e.debuglines=[]),e.recalc(),d()},e.toggleLockUser=function(){e.context.options.lockuser=!e.context.options.lockuser,d()},e.milking=!1;var N;e.start=function(){e.stop(),N=o(x,3e4)},e.stop=function(){N&&(o.cancel(N),N=null)},e.$on("$destroy",function(){e.stop()});var L=["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"],T=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];e.getDate=function(e,t){t=t||"/";var o=new Date;return"small"==e?o.getDate()+t+(o.getMonth()+1)+t+o.getFullYear():"verysmall"==e?o.getMonth()+1+t+o.getFullYear():L[o.getDay()]+" "+o.getDate()+" "+T[o.getMonth()]+" "+o.getFullYear()},e.recalc=function(){var t=0,o=0,n=h(e.context.o),a=h(e.context.p),r=0,c=!1,s=0,l=0,u=0,p=0,m=!1,d=a<e.context.options.halfday&&e.context.options.checklunch;e.context.items.forEach(function(n){if(u=w(n,"E"),u<e.context.options.min_e&&e.context.options.checkmine&&(u=e.context.options.min_e),!m&&v(u,p)&&e.context.options.checklunch){m=!0,n.lunch=!0;var d=u-p;d<e.context.options.min_lunch&&(t=e.context.options.min_lunch-d,d=e.context.options.min_lunch),d>e.context.options.max_lunch&&(t=d-e.context.options.max_lunch,d=e.context.options.max_lunch),n.L=i.getTime(d)}else n.lunch=!1;if(p=w(n,"U"),c=p>u){var x=p-u;n.minutes=i.getTime(x),r+=x}else n.minutes=0;if(u>0&&n.E){if(l=u,0==s&&(s=u,s>e.context.options.max_e&&0>=a&&e.context.options.checknine)){var g=s-e.context.options.max_e,f=Math.floor(g/30);g>30*f&&f++,o=30*f-g}p>0&&(l=p)}}),c&&e.context.items.push({E:"",U:""}),!m&&d&&(t=e.context.options.min_lunch);var x=l+n-r+t-a+o;x>e.context.options.min_e&&x<e.context.options.max_u||(x=0),e.context.startm=s,e.context.exitm=x,e.context.exit=x>0?i.getTime(x):"?",A()},e.clear=function(){var t=e.context&&e.context.user?e.context.user:{},o=e.context&&e.context.ass?e.context.ass:{},n=e.context.options;e.context={user:t,ass:o,o:"8",p:"0",exit:"?",items:[{E:"8:30",U:""}],options:n,inaz:{show:!1,items:[],analisys:{show:!1,da:"01/01/2015",a:e.getDate("small"),results:[]}},rap:{items:[],show:!1,date:e.getDate("verysmall"),advanced:!1,todate:e.getDate("verysmall"),headers:["Data","Cliente|Commessa","Lavoro","Attività","Descrizione|Idaol"],fields:[],selection:0},amonalie:{o:{show:!1,SSL:!0,multisep:",",casesens:!1,fields:[]},show:!1,headers:{values:["Codice","Data","Applicativo","Funzione","Versione","Stato","Oggetto","Descrizione","Istituto","Note","Tipo","Nome e cognome","eferenteTec","Attribuzioni"]},items:[],selection:[]},debug:{}},m(),e.recalc()},e.toggleAutoInaz=function(){e.context.user.auto=!e.context.user.auto,g()},e.toggleInaz=function(){e.context.inaz.show=!e.context.inaz.show,e.context.inaz.show&&(e.context.rap.show=!1,e.context.amonalie.show=!1,e.context.inaz.items&&e.context.inaz.items.length>0||x(!0))},e.reloadInaz=function(){x(!0)},e.inaz=function(){z()&&!e.context.user.auto&&x()},e.analisys=function(){e.context.inaz.analisys.show=!e.context.inaz.analisys.show,e.context.inaz.analisys.show&&e.context.inaz.analisys.calc()},e.calcAllItems=function(){if(e.context.allitems&&e.context.allitems.length>0){var t=[],o=[],n="";e.context.allitems.forEach(function(e){n!=e.C1&&(y(o,n,t),n=e.C1,t=[]),e.time=h(e.C2+":"+e.C3),t.push(e)}),y(o,n,t),e.context.inaz.items=o}},e.alarm=function(){D.paused?(e.context.options.alarms&&D.play(),I&&(I.i[I.p+"ed"]=!0)):(D.pause(),I||E(),I&&(I.i[I.p+"ed"]=!1,I.i[I.p]=!1,I=null)),e.isalarm=!D.paused},e.toggleAlarms=function(){e.context.options.alarms?(e.context.options.alarms=!1,E(),D.paused||e.alarm()):(e.context.options.alarms=!0,A()),d()},e.help=function(){e.helpon=!e.helpon,e.helpstyle={top:e.helpon?"10px":M}},e.downloadHistory=function(){if(z()){var o={user:e.context.user};t.post("/api/inaz/download",o).success(function(t){u("Storico completo inaz:",t);var o=JSON.stringify(t);o=o.replace(/,"\$\$hashKey":"object:\d+"/g,""),o=o.replace(/},{/g,"},\r\n{"),o=o.replace(/],"/g,'],\r\n"'),o=o.replace(/:\[{/g,":[\r\n{");var n=new Blob([o],{type:"text/json;charset=utf-8"}),a=e.getDate(null,"-");saveAs(n,"history_"+a+".json")}).error(function(e){l(e)})}},e.uploadHistoryContent=function(o){if(z()){var n=new FileReader;n.onload=function(o){var n={user:e.context.user,history:o.target.result};t.post("/api/inaz/upload",n).success(function(e){c.ok("Storici aggiornati correttamente!"),p(e)}).error(function(e){c.error("Errore in fase di richiesta rapportini",e)})},n.readAsText(o.files[0])}},e.uploadHistory=function(){z()&&angular.element("#history-file").trigger("click")},o(function(){var t=b(),o=e.context.exitm-e.context.startm,n=b()-e.context.startm,a=e.context.exitm-t;e.progress.value=o>0&&n>0?Math.floor(100*n/o):0,e.progress.elapsed=i.getTime(a)},2e3),e.toggleRap=function(){e.context.rap.show=!e.context.rap.show,e.context.rap.show&&(e.context.inaz.show=!1,e.context.amonalie.show=!1,e.context.rap.items||_())},e.reloadRap=function(){_()},e.toggleAmonalie=function(){e.context.amonalie.show||(e.context.inaz.show=!1,e.context.rap.show=!1),e.context.amonalie.show=!e.context.amonalie.show},e.reloadAmonalie=function(){if(!e.milking){d(),e.milking=!0;var o={user:e.context.ass,SSL:e.context.amonalie.o.SSL,debug:e.context.options.debug};t.post("/api/amonalie",o).success(function(t){u("Risultati della mungitura amonalie:",t.debug);var o=S(t.data);e.context.amonalie.headers=o.shift(),e.context.amonalie.items=o,e.milking=!1}).error(function(t){e.milking=!1,l(t,"ERRORE richiesta amonalie")})}},e.toggleAmonalieOptions=function(){e.context.amonalie.o.show=!e.context.amonalie.o.show},e.clear()}]);
