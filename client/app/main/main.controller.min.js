angular.module("krumiroApp").controller("TempiCtrl",["$scope","$http","$interval","$timeout","$window","Utilities","AES","Logger",function(a,b,c,d,e,f,g,h){function o(a,b){return a.time>b.time?1:a.time<b.time?-1:0}function p(a,b){b=b||"ERRORE richiesta file degli storici";var c=a&&!$.isEmptyObject(a)?a.message:"verificare le credenziali e riprovare.";h.error(b,c)}function q(b,c){a.context.options.debug&&(a.debuglines=a.debuglines||[],a.debuglines.push(b),$.isArray(c)?a.debuglines.push.apply(a.debuglines,c):a.debuglines.push(JSON.stringify(c)))}function r(b){a.context.allitems=b.data,a.context.meta=b.meta,a.calcAllItems()}function s(){if(localStorage){var b=localStorage.getItem(m);if(b&&!(b.length<=0))try{var c=JSON.parse(b);if(c&&(a.context.options.lockuser=c.lockuser,a.context.options.alarms=c.alarms,a.context.options.checklunch=c.checklunch,a.context.options.checkmine=c.checkmine,a.context.options.checknine=c.checknine,a.context.options.lockuser&&c.crd&&c.crd.name&&c.crd.pswd))try{a.context.user.name=g.decrypt(c.crd.name,k),a.context.user.password=g.decrypt(c.crd.pswd,k),a.context.ass.name=g.decrypt(c.ass.name,k),a.context.ass.password=g.decrypt(c.ass.pswd,k)}catch(a){h.error("Impossibile recuperare le credenziali",a)}}catch(a){localStorage.clear()}}}function t(){if(localStorage){a.context.options.crd={},a.context.options.ass={},a.context.options.lockuser&&(a.context.options.crd.name=g.encrypt(a.context.user.name,k),a.context.options.crd.pswd=g.encrypt(a.context.user.password,k),a.context.options.ass.name=g.encrypt(a.context.ass.name,k),a.context.options.ass.pswd=g.encrypt(a.context.ass.password,k));var b=JSON.stringify(a.context.options);localStorage.setItem(m,b)}}function u(c){if(!a.milking){t(),a.milking=!0;var d={all:c,user:a.context.user,work:z(a.context.o),perm:z(a.context.p),debug:a.context.options.debug};b.post("/api/inaz",d).success(function(b){if(q("Risultati della mungitura inaz:",b.debug),b&&b.data.length)if(c)r(b);else{var d=[],e={};b.data.forEach(function(a){a.time=z(a.C2+":"+a.C3)}),b.data.sort(o),b.data.forEach(function(a){"E"==a.C4?(e.E&&(d.push(e),e={}),e.E=a.C2+":"+a.C3):"U"==a.C4&&(e.U&&(d.push(e),e={}),e.U=a.C2+":"+a.C3)}),(e.E||e.U)&&d.push(e),a.context.items=d,a.recalc()}b&&b.error&&h.warning("Attenzione",b.error),a.milking=!1}).error(function(b){b&&b.debug&&q("Risultati della mungitura inaz:",b.debug),a.milking=!1,p(b)})}}function v(){if(!a.milking){t(),a.milking=!0;var c={user:a.context.user,debug:a.context.options.debug};b.post("/api/inaz/stat",c).success(function(b){if(b&&b.data.length){var c=b.data[0],d=[],e=new Date;d.push({title:"Anno",value:e.getFullYear()}),d.push({title:"Mese",value:C[e.getMonth()+1]}),d.push({title:"Residuo Anno Prec.",value:c.C1+"gg"}),d.push({title:"Maturato Anno",value:c.C2+"gg"}),d.push({title:"Goduti al mese corrente",value:c.C3+"gg"}),d.push({title:"Obiettivo al mese corrente",value:c.C4+"gg"}),d.push({title:"Differenza",value:c.C5+"gg"}),d.push({title:"Residuo attuale",value:c.C6+"gg"}),a.context.stat.data=d}a.milking=!1}).error(function(b){b&&b.debug&&q("Risultati della mungitura inaz:",b.debug),a.milking=!1,p(b)})}}function x(){a.context.user.auto&&!w?a.start():!a.context.user.auto&&w&&a.stop()}function y(a,b,c){var d=parseInt(a)||0;return d<b&&(d=b),d>c&&(d=c),d}function z(a){if(!a)return 0;var b=/\d+/g,c=a.match(b),d=0;if(c&&c.length>0){var e=y(c[0],0,23),f=0;c.length>1&&(f=y(c[1],0,59)),d=60*e+f}return d}function A(b,c){return c>0&&b>0&&b>a.context.options.start_lunch&&c<a.context.options.end_lunch}function D(a,b){var c=z(a[b]);return a[b+"M"]=c,c}function E(){return a.context.user.name&&a.context.user.password}function F(b,c,d){if(!(d.length<=0)){var e={day:c,dayn:f.parseDate(c),items:d.sort(o)};if(a.context.meta.length>0){var g=$.grep(a.context.meta,function(a){return a.day==c});g&&g.length>0&&(g[0].perm>0&&(e.perm=g[0].perm),480!=g[0].work&&(e.work=g[0].work))}b.push(e)}}function G(){var a=new Date;return 60*a.getHours()+a.getMinutes()}function H(b,c){return j={i:b,p:c},a.alarm(),!0}function I(){!angular.isDefined(n)&&a.context.options.alarms&&(n=c(function(){var b=G();a.context.exitm&&i.paused&&b>=a.context.exitm?(a.alarmed=!0,a.alarm()):a.context.items.some(function(a){return a.EM&&a.EM<=b&&a.ealarm?H(a,"ealarm"):!!(a.UM&&a.UM<=b&&a.ualarm)&&H(a,"ualarm")})},1e4))}function J(){angular.isDefined(n)&&(c.cancel(n),n=void 0),a.alarmed=!1}function K(){if(!a.milking){a.milking=!0;var c={user:a.context.user,date:a.context.rap.date,advanced:a.context.rap.advanced,todate:a.context.rap.todate,debug:a.context.options.debug};b.post("/api/rap",c).success(function(b){q("Risultati della mungitura rapportini:",b.debug),a.context.rap.items=b.data,a.milking=!1}).error(function(b){a.milking=!1,p(b,"ERRORE richiesta rapportini")})}}function L(a){var b=[];return a.forEach(function(a){b.push(M(a))}),b}function M(a){var b={values:[]};for(var c in a)b.values.push(a[c]);return b}var j,i=new Audio("assets/media/alarm.mp3"),k="431a12934fc4914912895c5103aa51b0",l="-1000px";const m="OPT";var n;a.helpon=!1,a.helpstyle={top:l},a.showopt=!1,a.optstyle={height:0},a.progress={forecolor:"yellowgreen",value:0,diameter:32,border:1},a.context={o:"8",p:"",exit:"?",items:[{E:"8:30",U:""}],options:{lockuser:!1,alarms:!1,checknine:!0,checklunch:!0,checkmine:!0,canautomilk:!1,debug:!1,halfday:240,min_e:510,max_e:540,max_u:1380,min_lunch:30,max_lunch:90,start_lunch:735,end_lunch:870},debug:{}},a.instractions={title:"Cosa puoi fare con CRUMIRO?",footer:"Se non ti basta .....",sections:[{icon:"fa-clock-o",title:"Puoi simulare le tue entrate ed uscite...",desc:"Inserendo le tue entrate e le tue uscite otterrai in automatico l'individuazione della pausa pranzo e l'ora di uscita."},{icon:"fa-clock-o",title:"Puoi impostare le ore di lavoro e di permesso...",desc:"Valorizzando correttamente le ore di permesso o di lavoro nel giorno puoi variare il calcolo dell'ora di uscita."},{icon:"fa-cloud-download",title:"Con le credenziali INAZ acquisisci i dati reali...",desc:"Inserendo le credenziali INAZ puoi scaricare manualmente le bedgiature cliccando sulla nuvoletta.\r\nOppure, attivando l'interruttore puoi lasciare fare all'applicazione che allinerà i dati ogni mezzo minuto."},{icon:"fa-bug",title:"Consultare le anomalie...",desc:"Inserendo le credenziali @Assistant puoi scaricare l'elenco delle anomalie e filtrarle come desideri."},{icon:"fa-calendar",title:"Vedere lo storico delle tue bedgiature...",desc:"Inserendo le credenziali INAZ puoi scaricare lo storico delle tue bedgiature cliccando sul calendarino sulla destra."},{icon:"fa-paw",title:"Vedere i rapportini lavorati nel mese...",desc:"Inserendo le credenziali INAZ puoi visualizzare l'elenco mensile dei rapportini e fare le tue ricerche calcolando le ore lavorate per commessa o lavoro o quant'altro."},{icon:"fa-bullhorn",title:"Aggiungere un allarme per ogni orario che desideri...",desc:"Attivando il megafonino in basso a sinistra puoi farti avvisare acusticamente (quindi devi avere il volume e degli altoparlanti attivi) all'ora d'uscita e, attivandoli separatamente ad ogni orario definito (altoparlantino nella cella dell'orario valorizzato)."},{icon:"fa-trophy",title:"Consultare lo stato dei permessi e delle ferie...",desc:"Inserendo le credenziali INAZ puoi consultare lo stato delle tue ferie e permessi utilizzati e rimanenti nell'anno in corso."}]},a.toggleOptions=function(){a.showopt=!a.showopt,a.optstyle={height:a.showopt?"190px":"0"}},a.toggleOptionValue=function(b){a.context.options[b]=!a.context.options[b],"debug"!=b||a.context.options[b]||(a.debuglines=[]),a.recalc(),t()},a.toggleLockUser=function(){a.context.options.lockuser=!a.context.options.lockuser,t()},a.milking=!1;var w;a.start=function(){a.stop(),w=c(u,3e4)},a.stop=function(){w&&(c.cancel(w),w=null)},a.$on("$destroy",function(){a.stop()});var B=["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"],C=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];a.getDate=function(a,b){b=b||"/";var c=new Date;return"small"==a?c.getDate()+b+(c.getMonth()+1)+b+c.getFullYear():"verysmall"==a?c.getMonth()+1+b+c.getFullYear():B[c.getDay()]+" "+c.getDate()+" "+C[c.getMonth()]+" "+c.getFullYear()},a.recalc=function(){var b=0,c=0,d=z(a.context.o),e=z(a.context.p),g=0,h=!1,i=0,j=0,k=0,l=0,m=!1,n=e<a.context.options.halfday&&a.context.options.checklunch;a.context.items.forEach(function(d){if(k=D(d,"E"),k<a.context.options.min_e&&a.context.options.checkmine&&(k=a.context.options.min_e),!m&&A(k,l)&&a.context.options.checklunch){m=!0,d.lunch=!0;var e=k-l;e<a.context.options.min_lunch&&(b=a.context.options.min_lunch-e,e=a.context.options.min_lunch),e>a.context.options.max_lunch&&(b=e-a.context.options.max_lunch,e=a.context.options.max_lunch),d.L=f.getTime(e)}else d.lunch=!1;if(l=D(d,"U"),h=l>k){var n=l-k;d.minutes=f.getTime(n),g+=n}else d.minutes=0;if(k>0&&d.E){if(j=k,0==i&&(i=k,i>a.context.options.max_e&&a.context.options.checknine)){var o=i-a.context.options.max_e,p=Math.floor(o/30);30*p<o&&p++,c=30*p-o}l>0&&(j=l)}}),h&&a.context.items.push({E:"",U:""}),!m&&n&&(b=a.context.options.min_lunch);var o=j+d-g+b-e+c;(o<=a.context.options.min_e||o>=a.context.options.max_u)&&(o=0),a.context.startm=i,a.context.exitm=o,a.context.exit=o>0?f.getTime(o):"?",I()},a.clear=function(){var b=a.context&&a.context.user?a.context.user:{},c=a.context&&a.context.ass?a.context.ass:{},d=a.context.options;a.context={user:b,ass:c,o:"8",p:"0",exit:"?",items:[{E:"8:30",U:""}],options:d,inaz:{show:!1,items:[],analisys:{show:!1,da:"01/01/2015",a:a.getDate("small"),results:[]}},stat:{show:!1},rap:{items:[],show:!1,date:a.getDate("verysmall"),advanced:!1,todate:a.getDate("verysmall"),headers:["Data","Cliente|Commessa","Lavoro","Attività","Descrizione|Idaol"],fields:[],selection:0},amonalie:{o:{show:!1,SSL:!0,multisep:",",casesens:!1,fields:[]},show:!1,headers:{values:["Codice","Data","Applicativo","Funzione","Versione","Stato","Oggetto","Descrizione","Istituto","Note","Tipo","Nome e cognome","ReferenteTec","Attribuzioni"]},items:[],selection:[]},debug:{}},s(),a.recalc()},a.toggleAutoInaz=function(){a.context.user.auto=!a.context.user.auto,x()},a.toggleInaz=function(){a.context.inaz.show=!a.context.inaz.show,a.context.inaz.show&&(a.context.rap.show=!1,a.context.amonalie.show=!1,(!a.context.inaz.items||a.context.inaz.items.length<=0)&&u(!0))},a.reloadInaz=function(){u(!0)},a.inaz=function(){E()&&!a.context.user.auto&&u()},a.analisys=function(){a.context.inaz.analisys.show=!a.context.inaz.analisys.show,a.context.inaz.analisys.show&&a.context.inaz.analisys.calc()},a.calcAllItems=function(){if(a.context.allitems&&!(a.context.allitems.length<=0)){var b=[],c=[],d="";a.context.allitems.forEach(function(a){d!=a.C1&&(F(c,d,b),d=a.C1,b=[]),a.time=z(a.C2+":"+a.C3),b.push(a)}),F(c,d,b),a.context.inaz.items=c}},a.alarm=function(){i.paused?(a.context.options.alarms&&i.play(),j&&(j.i[j.p+"ed"]=!0)):(i.pause(),j||J(),j&&(j.i[j.p+"ed"]=!1,j.i[j.p]=!1,j=null)),a.isalarm=!i.paused},a.toggleAlarms=function(){a.context.options.alarms?(a.context.options.alarms=!1,J(),i.paused||a.alarm()):(a.context.options.alarms=!0,I()),t()},a.help=function(){a.helpon=!a.helpon,a.helpstyle={top:a.helpon?"10px":l}},a.downloadHistory=function(){if(E()){var c={user:a.context.user};b.post("/api/inaz/download",c).success(function(b){q("Storico completo inaz:",b);var c=JSON.stringify(b);c=c.replace(/,"\$\$hashKey":"object:\d+"/g,""),c=c.replace(/},{/g,"},\r\n{"),c=c.replace(/],"/g,'],\r\n"'),c=c.replace(/:\[{/g,":[\r\n{");var d=new Blob([c],{type:"text/json;charset=utf-8"}),e=a.getDate(null,"-");saveAs(d,"history_"+e+".json")}).error(function(a){p(a)})}},a.uploadHistoryContent=function(c){if(E()){var d=new FileReader;d.onload=function(c){var d={user:a.context.user,history:c.target.result};b.post("/api/inaz/upload",d).success(function(a){h.ok("Storici aggiornati correttamente!"),r(a)}).error(function(a){h.error("Errore in fase di richiesta rapportini",a)})},d.readAsText(c.files[0])}},a.uploadHistory=function(){E()&&angular.element("#history-file").trigger("click")},c(function(){var b=G(),c=a.context.exitm-a.context.startm,d=G()-a.context.startm,e=a.context.exitm-b;a.progress.value=c<=0||d<=0?0:Math.floor(100*d/c),a.progress.elapsed=f.getTime(e)},2e3),a.toggleRap=function(){a.context.rap.show=!a.context.rap.show,a.context.rap.show&&(a.context.inaz.show=!1,a.context.amonalie.show=!1,a.context.rap.items||K())},a.reloadRap=function(){K()},a.toggleAmonalie=function(){a.context.amonalie.show||(a.context.inaz.show=!1,a.context.rap.show=!1),a.context.amonalie.show=!a.context.amonalie.show},a.reloadAmonalie=function(){if(!a.milking){t(),a.milking=!0;var c={user:a.context.ass,SSL:a.context.amonalie.o.SSL,debug:a.context.options.debug};b.post("/api/amonalie",c).success(function(b){q("Risultati della mungitura amonalie:",b.debug);var c=L(b.data);a.context.amonalie.headers=c.shift(),a.context.amonalie.items=c,a.milking=!1}).error(function(b){a.milking=!1,p(b,"ERRORE richiesta amonalie")})}},a.toggleAmonalieOptions=function(){a.context.amonalie.o.show=!a.context.amonalie.o.show},a.toggleStat=function(){a.context.stat.show=!a.context.stat.show,a.context.stat.show&&!a.context.stat.data&&v()},b.get("/api/info").success(function(b){a.product=b.product}),a.clear()}]);
